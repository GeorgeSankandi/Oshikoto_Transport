<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <h1 class="display-5 mb-0">Admin Dashboard</h1>
        <p class="lead text-muted mb-0">Welcome, {{user.name}}. Full control panel.</p>
    </div>
    <div class="d-flex gap-2">
        <a href="/" class="btn btn-outline-primary">
            <i class="fas fa-home me-2"></i>Back to Home
        </a>
        <a href="/logout" class="btn btn-danger">
            <i class="fas fa-sign-out-alt me-2"></i>Logout
        </a>
    </div>
</div>
<hr>

<!-- Tab Navigation -->
<ul class="nav nav-tabs mb-4" id="adminTab" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="bookings-tab" data-bs-toggle="tab" data-bs-target="#bookings-pane" type="button" role="tab" aria-controls="bookings-pane" aria-selected="true">Bookings</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="content-tab" data-bs-toggle="tab" data-bs-target="#content-pane" type="button" role="tab" aria-controls="content-pane" aria-selected="false">Site Content</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="users-tab" data-bs-toggle="tab" data-bs-target="#users-pane" type="button" role="tab" aria-controls="users-pane" aria-selected="false">Users</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="articles-tab" data-bs-toggle="tab" data-bs-target="#articles-pane" type="button" role="tab" aria-controls="articles-pane" aria-selected="false">Articles</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="services-tab" data-bs-toggle="tab" data-bs-target="#services-pane" type="button" role="tab" aria-controls="services-pane" aria-selected="false">Services</button>
  </li>
  <!-- ADDED: Gallery Tab -->
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="gallery-tab" data-bs-toggle="tab" data-bs-target="#gallery-pane" type="button" role="tab" aria-controls="gallery-pane" aria-selected="false">Image Gallery</button>
  </li>
</ul>

<!-- Tab Content -->
<div class="tab-content" id="adminTabContent">

  <!-- =============================== -->
  <!-- ===    BOOKINGS PANE        === -->
  <!-- =============================== -->
  <div class="tab-pane fade show active" id="bookings-pane" role="tabpanel" aria-labelledby="bookings-tab" tabindex="0">
    <h3 class="section-title">All Bookings</h3>
    {{#if bookings}}
    <div class="table-responsive">
        <table class="table table-striped table-hover align-middle">
       <thead>
            <tr>
                <th>Client</th>
                <th>Provider</th>
                <th>Service</th>
                <th>Status</th>
                <th>Checklist</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {{#each bookings}}
            <tr>
                <td>{{client.name}}</td>
                <td>{{provider.name}}</td>
                <td>{{service.title}}</td>
                <td><span class="badge {{#if (ifeq status 'Confirmed')}}bg-success{{else}}bg-secondary{{/if}}">{{status}}</span></td>
                <td>
                    <a href="/dashboard/checklist/{{this._id}}" class="btn btn-sm {{#if this.hasChecklist}}btn-warning{{else}}btn-outline-primary{{/if}}">
                        <i class="fas {{#if this.hasChecklist}}fa-edit{{else}}fa-plus{{/if}} me-1"></i>
                        {{#if this.hasChecklist}}View/Edit{{else}}Fill{{/if}}
                    </a>
                    
                    {{#if this.hasChecklist}}
                    <a href="/bookings/{{this._id}}/checklist/download" class="btn btn-sm btn-outline-secondary" title="Download PDF" target="_blank">
                        <i class="fas fa-file-pdf"></i>
                    </a>
                    {{/if}}
                </td>
                <td>
                    <form action="/bookings/{{this._id}}?_method=DELETE" method="POST" class="d-inline" onsubmit="return confirm('Are you sure? This will delete the booking and any associated checklist permanently.');">
                        <button type="submit" class="btn btn-sm btn-danger" title="Delete Booking">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </form>
                </td>
            </tr>
            {{/each}}
        </tbody>
    </table>
</div>
{{else}}
<p>There are no bookings on the platform.</p>
{{/if}}
  </div>

  <!-- ================================== -->
  <!-- === SITE CONTENT MANAGER PANE  === -->
  <!-- ================================== -->
  <div class="tab-pane fade" id="content-pane" role="tabpanel" aria-labelledby="content-tab" tabindex="0">
    <h3 class="section-title">Manage Site Content</h3>
    <div class="card mb-5">
        <div class="card-body p-4">
            <form action="/dashboard/site-content" method="POST" enctype="multipart/form-data">
                
                <h5 class="card-title text-primary">General Page Configurations</h5>
                <div class="p-3 mb-3 border rounded bg-white shadow-sm">
                    
                    <!-- Feature: Portfolio Toggle & Text -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">Construction Page: Portfolio Section</label>
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" id="construction_portfolio_visible" name="construction_portfolio_visible" value="true" {{#if (ifeq siteContent.construction_portfolio_visible 'true')}}checked{{/if}}>
                            <label class="form-check-label" for="construction_portfolio_visible">Show "Featured Namibian Projects" Section</label>
                        </div>
                        <label class="form-label small text-muted">Portfolio Intro Text</label>
                        <textarea name="construction_portfolio_intro" class="form-control" rows="2">{{siteContent.construction_portfolio_intro}}</textarea>
                    </div>

                    <hr>

                    <!-- Feature: About Team Text -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">About Page: "Meet Our Team" Intro Text</label>
                        <textarea name="about_team_intro" class="form-control" rows="2">{{siteContent.about_team_intro}}</textarea>
                    </div>

                    <hr>

                    <!-- Feature: Contact Map -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Contact Page: Map Location</label>
                        <div class="input-group">
                            <input type="text" id="contact_map_query" name="contact_map_query" class="form-control" value="{{siteContent.contact_map_query}}" placeholder="e.g. Windhoek, Namibia or Coordinates">
                            <button class="btn btn-outline-secondary" type="button" id="btn-geo-locate">
                                <i class="fas fa-map-marker-alt"></i> Use Current Location
                            </button>
                        </div>
                        <small class="text-muted">Enter a city name or click the button to use your current GPS coordinates.</small>
                    </div>
                </div>

                <hr class="my-4">
                <h5 class="card-title">1. Hero Sections Content</h5>
                {{#each (array 'home' 'about' 'services' 'articles' 'contact')}}
                <div class="p-3 mb-3" style="background-color: #f8f9fa; border-radius: .25rem; border: 1px solid #dee2e6;">
                    <h6 class="text-capitalize">{{this}} Page Hero</h6>
                    <div class="mb-3">
                        <label class="form-label">Hero Title</label>
                        <input type="text" name="{{this}}_hero_title" class="form-control" value="{{lookup ../siteContent (concat this '_hero_title')}}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Hero Subtitle</label>
                        <input type="text" name="{{this}}_hero_subtitle" class="form-control" value="{{lookup ../siteContent (concat this '_hero_subtitle')}}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Hero Background Image</label>
                        <input type="file" name="{{this}}_hero_image" class="form-control">
                        <small class="text-muted d-block">Current: {{lookup ../siteContent (concat this '_hero_image')}}</small>
                    </div>
                </div>
                {{/each}}

                <hr class="my-4">
                <h5 class="card-title">2. Home Page "About" Section</h5>
                <div class="p-3 mb-3 border rounded bg-white shadow-sm">
                    <div class="mb-3">
                        <label for="home_about_text" class="form-label">About Section Text</label>
                        <textarea id="home_about_text" name="home_about_text" class="form-control" rows="4">{{siteContent.home_about_text}}</textarea>
                    </div>
                    <div class="mb-3">
                        <label for="home_about_image" class="form-label">About Section Image</label>
                        <input type="file" id="home_about_image" name="home_about_image" class="form-control">
                        <small class="text-muted d-block">Current: {{siteContent.home_about_image}}</small>
                    </div>
                </div>

                <hr class="my-4">
                <h5 class="card-title">3. Individual Service Pillar Pages</h5>
                {{#each (array 'transport' 'construction' 'technical' 'general')}}
                <div class="p-3 mb-3 border rounded bg-white shadow-sm">
                    <h6 class="text-primary text-capitalize">{{this}} Page Content</h6>
                    <div class="mb-3">
                        <label class="form-label">Section Title</label>
                        <input type="text" name="{{this}}_section_title" class="form-control" value="{{lookup ../siteContent (concat this '_section_title')}}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Section Description</label>
                        <textarea name="{{this}}_section_desc" class="form-control" rows="4">{{lookup ../siteContent (concat this '_section_desc')}}</textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Section Image</label>
                        <input type="file" name="{{this}}_section_image" class="form-control">
                        <small class="text-muted d-block">Current: {{lookup ../siteContent (concat this '_section_image')}}</small>
                    </div>
                </div>
                {{/each}}
                
                <hr class="my-4">
                <h5 class="card-title">4. About Us Page - Transportation Fleet Text</h5>
                <div class="p-3 mb-3 border rounded bg-white shadow-sm">
                    <div class="mb-3">
                        <label class="form-label">Transportation Body Text</label>
                        <textarea name="about_transport_text" class="form-control" rows="4">{{siteContent.about_transport_text}}</textarea>
                    </div>
                </div>

                <hr class="my-4">
                <h5 class="card-title">5. About Us - Mission, Vision & Why Us</h5>
                <div class="p-3 mb-3 border rounded bg-white shadow-sm">
                    <div class="row">
                        <!-- Mission -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Our Mission Text</label>
                            <textarea name="about_mission_text" class="form-control" rows="3">{{siteContent.about_mission_text}}</textarea>
                            <div class="mt-2">
                                <label class="form-label small">Mission Image</label>
                                <input type="file" name="about_mission_image" class="form-control form-control-sm">
                                <small class="text-muted d-block">Current: {{siteContent.about_mission_image}}</small>
                            </div>
                        </div>
                        
                        <!-- Vision -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Our Vision Text</label>
                            <textarea name="about_vision_text" class="form-control" rows="3">{{siteContent.about_vision_text}}</textarea>
                            <div class="mt-2">
                                <label class="form-label small">Vision Image</label>
                                <input type="file" name="about_vision_image" class="form-control form-control-sm">
                                <small class="text-muted d-block">Current: {{siteContent.about_vision_image}}</small>
                            </div>
                        </div>
                    </div>

                    <hr>
                    <label class="form-label fw-bold text-primary">"Why Choose Us" Section</label>
                    <div class="row">
                        <!-- Reason 1 -->
                        <div class="col-md-3 mb-2">
                            <input type="text" name="about_why_1_title" class="form-control mb-1 fw-bold" value="{{siteContent.about_why_1_title}}" placeholder="Title 1">
                            <textarea name="about_why_1_text" class="form-control" rows="2" placeholder="Desc 1">{{siteContent.about_why_1_text}}</textarea>
                        </div>
                        <!-- Reason 2 -->
                        <div class="col-md-3 mb-2">
                            <input type="text" name="about_why_2_title" class="form-control mb-1 fw-bold" value="{{siteContent.about_why_2_title}}" placeholder="Title 2">
                            <textarea name="about_why_2_text" class="form-control" rows="2" placeholder="Desc 2">{{siteContent.about_why_2_text}}</textarea>
                        </div>
                        <!-- Reason 3 -->
                        <div class="col-md-3 mb-2">
                            <input type="text" name="about_why_3_title" class="form-control mb-1 fw-bold" value="{{siteContent.about_why_3_title}}" placeholder="Title 3">
                            <textarea name="about_why_3_text" class="form-control" rows="2" placeholder="Desc 3">{{siteContent.about_why_3_text}}</textarea>
                        </div>
                        <!-- Reason 4 -->
                        <div class="col-md-3 mb-2">
                            <input type="text" name="about_why_4_title" class="form-control mb-1 fw-bold" value="{{siteContent.about_why_4_title}}" placeholder="Title 4">
                            <textarea name="about_why_4_text" class="form-control" rows="2" placeholder="Desc 4">{{siteContent.about_why_4_text}}</textarea>
                        </div>
                    </div>
                </div>

                <hr class="my-4">
                <h5 class="card-title">6. Contact Us Page Details</h5>
                <div class="p-3 mb-3 border rounded bg-white shadow-sm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Intro Title</label>
                            <input type="text" name="contact_intro_title" class="form-control" value="{{siteContent.contact_intro_title}}">
                        </div>
                         <div class="col-md-6 mb-3">
                            <label class="form-label">Address</label>
                            <input type="text" name="contact_address" class="form-control" value="{{siteContent.contact_address}}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Email</label>
                            <input type="text" name="contact_email" class="form-control" value="{{siteContent.contact_email}}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Phone</label>
                            <input type="text" name="contact_phone" class="form-control" value="{{siteContent.contact_phone}}">
                        </div>
                        <div class="col-12 mb-3">
                            <label class="form-label">Intro Description</label>
                            <textarea name="contact_intro_desc" class="form-control" rows="3">{{siteContent.contact_intro_desc}}</textarea>
                        </div>
                    </div>
                </div>

                <hr class="my-4">
                <h5 class="card-title">7. "Meet Our Team" Section</h5>
                <div class="row">
                    {{#each (array '1' '2' '3')}}
                    <div class="col-md-4 mb-3">
                        <div class="p-3 border rounded bg-white shadow-sm">
                            <p class="fw-bold">Team Member {{this}}</p>
                            <div class="mb-2">
                                <label class="form-label small">Name</label>
                                <input type="text" name="about_team_{{this}}_name" class="form-control" value="{{lookup ../siteContent (concat 'about_team_' this '_name')}}">
                            </div>
                            <div class="mb-2">
                                <label class="form-label small">Role</label>
                                <input type="text" name="about_team_{{this}}_title" class="form-control" value="{{lookup ../siteContent (concat 'about_team_' this '_title')}}">
                            </div>
                            <div class="mb-2">
                                <label class="form-label small">Bio</label>
                                <textarea name="about_team_{{this}}_bio" class="form-control" rows="4">{{lookup ../siteContent (concat 'about_team_' this '_bio')}}</textarea>
                            </div>
                            <div class="mb-2">
                                <label class="form-label small">Photo</label>
                                <input type="file" name="about_team_{{this}}_image" class="form-control">
                                <small class="text-muted d-block">Current: {{lookup ../siteContent (concat 'about_team_' this '_image')}}</small>
                            </div>
                        </div>
                    </div>
                    {{/each}}
                </div>

                <button type="submit" class="btn btn-primary btn-lg w-100 mt-4">Save All Site Content</button>
            </form>
        </div>
    </div>
  </div>

  <!-- =============================== -->
  <!-- ===    USERS PANE           === -->
  <!-- =============================== -->
  <div class="tab-pane fade" id="users-pane" role="tabpanel" aria-labelledby="users-tab" tabindex="0">
    <h3 class="section-title">All Registered Users</h3>
    {{#if allUsers}}
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Role</th>
                    <th>Joined</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {{#each allUsers}}
                <tr>
                    <td>{{this.name}}</td>
                    <td>{{this.email}}</td>
                    <td><span class="badge bg-secondary">{{this.role}}</span></td>
                    <td>{{formatDate this.createdAt 'YYYY-MM-DD'}}</td>
                    <td>
                        {{#unless (ifeq this.role 'admin')}}
                        <form action="/dashboard/users/{{this._id}}?_method=DELETE" method="POST" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this user?');">
                            <input type="submit" value="Delete" class="btn btn-sm btn-danger">
                        </form>
                        {{else}}
                        <span class="text-muted small">Admin</span>
                        {{/unless}}
                    </td>
                </tr>
                {{/each}}
            </tbody>
        </table>
    </div>
    {{else}}
    <p>No users found.</p>
    {{/if}}
  </div>

  <!-- =============================== -->
  <!-- ===    ARTICLES PANE        === -->
  <!-- =============================== -->
  <div class="tab-pane fade" id="articles-pane" role="tabpanel" aria-labelledby="articles-tab" tabindex="0">
    <h3 class="section-title">Manage Articles</h3>
    <div class="card mb-5">
        <div class="card-body p-4">
            <h5 class="card-title">Create New Article</h5>
            <form action="/articles" method="POST" enctype="multipart/form-data">
                <div class="mb-3">
                    <label for="title" class="form-label">Article Title</label>
                    <input type="text" id="title" name="title" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label for="snippet" class="form-label">Snippet</label>
                    <input type="text" id="snippet" name="snippet" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label for="serviceImage" class="form-label">Article Image</label>
                    <input type="file" id="serviceImage" name="serviceImage" class="form-control">
                </div>
                <div class="mb-3">
                    <label for="content" class="form-label">Full Content</label>
                    <textarea id="content" name="content" class="form-control" rows="8" required></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Create Article</button>
            </form>
        </div>
    </div>

    <h5 class="mt-5">Existing Articles</h5>
    {{#if articles}}
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>Title</th>
                    <th>Snippet</th>
                    <th>Created</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {{#each articles}}
                <tr>
                    <td>{{this.title}}</td>
                    <td>{{this.snippet}}</td>
                    <td>{{formatDate this.createdAt 'YYYY-MM-DD'}}</td>
                    <td>
                        <a href="/articles/edit/{{this._id}}" class="btn btn-sm btn-secondary">Edit</a>
                        <form action="/articles/{{this._id}}?_method=DELETE" method="POST" class="d-inline">
                            <input type="submit" value="Delete" class="btn btn-sm btn-danger">
                        </form>
                    </td>
                </tr>
                {{/each}}
            </tbody>
        </table>
    </div>
    {{/if}}
  </div>

  <!-- =============================== -->
  <!-- ===    SERVICES PANE        === -->
  <!-- =============================== -->
  <div class="tab-pane fade" id="services-pane" role="tabpanel" aria-labelledby="services-tab" tabindex="0">
    <h3 class="section-title">All Services on Platform</h3>
    <div class="card mb-4">
        <div class="card-body p-3">
            <h5 class="card-title">Create New Service</h5>
            
            {{!-- Checklist Styling --}}
            <link rel="stylesheet" href="/css/checklist-style.css">
            <style>
                /* Enforce column widths for alignment */
                .checklist-edit-table {
                    table-layout: fixed;
                    width: 100%;
                    border-collapse: separate;
                    border-spacing: 0;
                }
                .checklist-edit-table th.col-desc { width: 40%; }
                .checklist-edit-table th.col-class { width: 10%; text-align: center; }
                .checklist-edit-table th.col-switch { width: 30%; text-align: center; }
                .checklist-edit-table th.col-arr { width: 20%; text-align: center; }
                
                .checklist-edit-table td {
                    vertical-align: middle;
                    border-bottom: 1px solid #dee2e6;
                }

                .checklist-edit-table td.switch-td {
                    background-color: white !important;
                    padding: 0 !important;
                    height: 1px;
                }
                
                .checklist-edit-table .switch-cell {
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    width: 100%;
                    height: 100%; 
                    min-height: 45px;
                }

                .checklist-edit-table input[type="time"] {
                    text-align: center;
                    cursor: pointer;
                    background-color: #fff;
                }
                
                .checklist-edit-table input[type="time"].filled::-webkit-calendar-picker-indicator {
                    display: none;
                    -webkit-appearance: none;
                }

                .sub-item-text {
                    padding-left: 20px;
                }
                
                .class-a {
                    color: #dc3545; /* Bootstrap danger red */
                    font-weight: bold;
                }
            </style>

            <form id="createServiceForm" action="/services" method="POST" enctype="multipart/form-data" class="row g-2">
                <input type="hidden" name="checklist_template_json" id="checklist_template_json">
                
                <div class="col-md-4">
                    <label class="form-label">Title</label>
                    <input type="text" name="title" class="form-control" required>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Category</label>
                    <select name="category" id="categorySelect" class="form-select" required>
                        <option value="">Select Category...</option>
                        <option value="Transportation & Carwash">Transportation & Carwash</option>
                        <option value="Civil & Building Construction">Civil & Building Construction</option>
                        <option value="Road Works">Road Works</option>
                        <option value="Mining Support">Mining Support</option>
                        <option value="Technical & Repair Services">Technical & Repair Services</option>
                        <option value="Farming & Agriculture">Farming & Agriculture</option>
                        <option value="Property Development">Property Development</option>
                        <option value="General Services & Supply">General Services & Supply</option>
                        <option value="Catering, Cleaning & Laundry">Catering, Cleaning & Laundry</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Price (N$)</label>
                    <input type="number" name="price" class="form-control" step="0.01" required>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Image</label>
                    <input type="file" name="serviceImage" class="form-control" accept="image/*">
                </div>
                <div class="col-12">
                    <label class="form-label">Short Description</label>
                    <textarea name="description" class="form-control" rows="2"></textarea>
                </div>
                <div class="col-md-3">
                    <div class="form-check mt-2">
                        <input class="form-check-input" type="checkbox" name="onSale" id="onSaleCheck">
                        <label class="form-check-label" for="onSaleCheck">On Sale</label>
                    </div>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Sale End Date</label>
                    <input type="date" name="saleEndDate" class="form-control">
                </div>
                
                <!-- ============================================= -->
                <!-- === SECTION: FLEET DOCUMENTS (Transport)  === -->
                <!-- ============================================= -->
                <div id="fleetDocsAdmin" class="col-12 mt-4" style="display:none;">
                    <div class="mb-3 border-bottom pb-2">
                        <h6 class="text-primary">Fleet Documents</h6>
                        <p class="text-muted small mb-0">Upload PDF documents for vehicles. Add checklist items that clients must verify.</p>
                    </div>
                    <div class="row g-2">
                        {{#each (array '1' '2' '3' '4' '5')}}
                        <div class="col-md-6 mb-4">
                            <div class="border rounded p-3 bg-light h-100">
                                <label class="form-label small fw-bold">Document {{this}}</label>
                                <div class="mb-3">
                                    <input type="text" name="fleet_doc_{{this}}_name" class="form-control form-control-sm" placeholder="e.g. Safety Permit">
                                </div>
                                <div class="mb-3">
                                    <small class="text-muted d-block mb-1">Select PDF file:</small>
                                    <input type="file" name="fleet_doc_{{this}}" class="form-control form-control-sm" accept=".pdf">
                                </div>
                                <div class="bg-white rounded p-2" style="border: 1px solid #dee2e6;">
                                    <label class="form-label small fw-bold text-secondary mb-2 d-block">Checklist Items</label>
                                    <div class="checklist-items" data-doc="{{this}}">
                                        <div class="checklist-item mb-2">
                                            <div class="input-group input-group-sm">
                                                <input type="text" name="fleet_doc_{{this}}_checklist_1_item" class="form-control" placeholder="e.g. Brake fluid level">
                                                <input type="text" name="fleet_doc_{{this}}_checklist_1_category" class="form-control" placeholder="Category" style="max-width: 120px;">
                                            </div>
                                        </div>
                                    </div>
                                    <button type="button" class="btn btn-sm btn-outline-secondary mt-2 add-checklist-item" data-doc="{{this}}">+ Add Item</button>
                                </div>
                            </div>
                        </div>
                        {{/each}}
                    </div>
                </div>

                <!-- ============================================= -->
                <!-- === SECTION: CHECKLIST TEMPLATE (Transport)=== -->
                <!-- ============================================= -->
                <div id="checklistTemplateSection" class="col-12 mt-4" style="display:none;">
                    <hr class="my-5">
                    <h4 class="mb-3 text-primary">Pre-Departure Checklist Template Configuration</h4>
                    <div class="alert alert-info py-2"><i class="fas fa-info-circle me-2"></i>Configure the <strong>default</strong> state for the inputs below.</div>
                    
                    <div id="checklistForm" class="border p-3 bg-white">
                        <!-- Header (Visual Only) -->
                        <header class="header-grid">
                            <div class="header-col-1">
                                <p><strong>Company Name:</strong><br>Oshikoto Transport & Investment CC</p>
                                <p><strong>Document Type:</strong><br>Health, Safety & Environmental Checklist</p>
                            </div>
                            <div class="header-col-2">
                                <p><strong>Document No./Saved As:</strong> C002</p>
                                <p><strong>Revision Number:</strong> 01</p>
                                <p><strong>Page:</strong> Page 1 of 2</p>
                            </div>
                            <div class="header-col-3">
                                <div class="logo-box">
                                    <img src="/images/companylogo.png" alt="Logo" style="max-height: 50px;">
                                </div>
                            </div>
                        </header>

                        <h1 class="checklist-title">Daily Fleet Pre-Departure Checklist</h1>

                        <!-- Info Grid (Enabled for Template Defaults) -->
                        <div class="info-grid">
                            <div class="info-cell"><strong>Date</strong><input type="date" name="date"></div>
                            <div class="info-cell"><strong>Department / Branch</strong><input type="text" name="department"></div>
                            <div class="info-cell"><strong>Registration No</strong><input type="text" name="registrationNo"></div>
                            <div class="info-cell"><strong>Odometer Reading</strong><input type="number" name="odometerReading"></div>
                            <div class="info-cell"><strong>Route</strong><input type="text" name="route"></div>
                            <div class="info-cell"><strong>Seats Occupied</strong><input type="number" name="seatsOccupied"></div>
                            <div class="info-cell route-cell"><strong>To site</strong><input type="text" name="toSite"></div>
                            <div class="info-cell route-cell"><strong>Return</strong><input type="text" name="return"></div>
                            
                            <!-- Shift Selection -->
                            <div class="info-cell shift-group-wrapper" style="grid-column: span 4;">
                                <strong>Shift</strong>
                                <div class="shift-toggle-group">
                                    <label><input type="radio" name="shift" value="Morning Shifts"><span>Morning Shifts</span></label>
                                    <label><input type="radio" name="shift" value="Afternoon Shift"><span>Afternoon Shift</span></label>
                                    <label><input type="radio" name="shift" value="8 to 8 Shift"><span>8 to 8 Shift</span></label>
                                    <label><input type="radio" name="shift" value="Night Shift"><span>Night Shift</span></label>
                                </div>
                            </div>
                        </div>

                        <div class="instructions">
                            <p>* If item is in order, please mark with a "OK"</p>
                            <p>* If there is a problem with an item, please mark - **DEF**</p>
                            <p>* Mark Fire Extinguisher and First Aid Kit area with (**Y/N**)</p>
                        </div>

                        <div class="checklist-container">
                            <!-- Table 1: External Checks (Left Column) -->
                            <table class="checklist-table checklist-edit-table">
                                <thead>
                                    <tr>
                                        <th class="col-desc">Description</th>
                                        <th class="col-class">Class</th>
                                        <th class="col-switch">Dep. Status</th>
                                        <th class="col-arr">Arr. Time</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="section-header"><td colspan="4"><strong>External Checks:</strong></td></tr>
                                    
                                    <tr>
                                        <td class="class-a">Brake Fluid</td>
                                        <td class="text-center class-a">A</td>
                                        {{> _checklist_switch name="Brake_Fluid"}}
                                    </tr>
                                    <tr>
                                        <td>Window Washer Fluid</td>
                                        <td class="text-center">B</td>
                                        {{> _checklist_switch name="Window_Washer_Fluid"}}
                                    </tr>
                                    <tr>
                                        <td>Door Handles</td>
                                        <td class="text-center">B</td>
                                        {{> _checklist_switch name="Door_Handles"}}
                                    </tr>
                                    <tr>
                                        <td class="class-a">License valid</td>
                                        <td class="text-center class-a">A</td>
                                        {{> _checklist_switch name="License_valid"}}
                                    </tr>
                                    <tr>
                                        <td>Branding Intact</td>
                                        <td class="text-center">B</td>
                                        {{> _checklist_switch name="Branding_Intact"}}
                                    </tr>
                                    <tr>
                                        <td>Lights - Brake Lights</td>
                                        <td class="text-center">B</td>
                                        {{> _checklist_switch name="Lights_Brake_Lights"}}
                                    </tr>
                                    <tr>
                                        <td class="sub-item-text">- Brights / Dimmed</td>
                                        <td class="text-center">B</td>
                                        {{> _checklist_switch name="Lights_Brights_Dimmed"}}
                                    </tr>
                                    <tr>
                                        <td class="sub-item-text">- Indicators</td>
                                        <td class="text-center">B</td>
                                        {{> _checklist_switch name="Lights_Indicators"}}
                                    </tr>
                                    <tr>
                                        <td class="sub-item-text">- Reverse Lights</td>
                                        <td class="text-center">B</td>
                                        {{> _checklist_switch name="Lights_Reverse_Lights"}}
                                    </tr>
                                    <tr>
                                        <td class="sub-item-text">- Room lights</td>
                                        <td class="text-center">B</td>
                                        {{> _checklist_switch name="Lights_Room_lights_Ext"}}
                                    </tr>
                                    <tr>
                                        <td class="sub-item-text">- Fog light</td>
                                        <td class="text-center">B</td>
                                        {{> _checklist_switch name="Fog_light"}}
                                    </tr>
                                    <tr>
                                        <td class="class-a">Oil Leaks</td>
                                        <td class="text-center class-a">A</td>
                                        {{> _checklist_switch name="Oil_Leaks"}}
                                    </tr>
                                    <tr>
                                        <td>Oil Level</td>
                                        <td class="text-center">B</td>
                                        {{> _checklist_switch name="Oil_Level"}}
                                    </tr>
                                    <tr>
                                        <td>Spare Wheel</td>
                                        <td class="text-center">B</td>
                                        {{> _checklist_switch name="Spare_Wheel"}}
                                    </tr>
                                    <tr>
                                        <td class="class-a">Tire Tread</td>
                                        <td class="text-center class-a">A</td>
                                        {{> _checklist_switch name="Tire_Tread"}}
                                    </tr>
                                    <tr>
                                        <td class="class-a">Power steering fluid</td>
                                        <td class="text-center class-a">A</td>
                                        {{> _checklist_switch name="Power_steering_fluid"}}
                                    </tr>
                                    <tr>
                                        <td class="class-a">Water Leaks</td>
                                        <td class="text-center class-a">A</td>
                                        {{> _checklist_switch name="Water_Leaks"}}
                                    </tr>
                                    <tr>
                                        <td class="class-a">Wheel Nuts</td>
                                        <td class="text-center class-a">A</td>
                                        {{> _checklist_switch name="Wheel_Nuts"}}
                                    </tr>
                                    <tr>
                                        <td>Windows (cracked / chipped)</td>
                                        <td class="text-center">B</td>
                                        {{> _checklist_switch name="Windows"}}
                                    </tr>
                                    <tr>
                                        <td>Wiper Blades</td>
                                        <td class="text-center">B</td>
                                        {{> _checklist_switch name="Wiper_Blades"}}
                                    </tr>
                                    <tr>
                                        <td>Triangles (x2) [in case of breakdown]</td>
                                        <td class="text-center">B</td>
                                        {{> _checklist_switch name="Triangles"}}
                                    </tr>
                                    <tr>
                                        <td>Jack</td>
                                        <td class="text-center">B</td>
                                        {{> _checklist_switch name="Jack"}}
                                    </tr>
                                    <tr>
                                        <td>Reflective Jacket (optional)</td>
                                        <td class="text-center">B</td>
                                        {{> _checklist_switch name="Reflective_Jacket"}}
                                    </tr>
                                </tbody>
                            </table>

                            <!-- Table 2: Right Column -->
                            <table class="checklist-table checklist-edit-table">
                                <thead>
                                    <tr>
                                        <th class="col-desc">Description</th>
                                        <th class="col-class">Class</th>
                                        <th class="col-switch">Dep. Status</th>
                                        <th class="col-arr">Arr. Time</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="section-header"><td colspan="4"><strong>External checks (continued)</strong></td></tr>
                                    
                                    <tr>
                                        <td>Camera working</td>
                                        <td class="text-center">B</td>
                                        {{> _checklist_switch name="Camera_working"}}
                                    </tr>
                                    <tr>
                                        <td class="class-a">Service brake</td>
                                        <td class="text-center class-a">A</td>
                                        {{> _checklist_switch name="Service_brake"}}
                                    </tr>
                                    <tr>
                                        <td>Toolbox</td>
                                        <td class="text-center">B</td>
                                        {{> _checklist_switch name="Toolbox"}}
                                    </tr>
                                    <tr>
                                        <td>Spare spanners</td>
                                        <td class="text-center">B</td>
                                        {{> _checklist_switch name="Spare_spanners"}}
                                    </tr>
                                    <tr>
                                        <td class="class-a">Wheel spanner</td>
                                        <td class="text-center class-a">A</td>
                                        {{> _checklist_switch name="Wheel_spanner"}}
                                    </tr>
                                    <tr>
                                        <td class="class-a">100 km sticker</td>
                                        <td class="text-center class-a">A</td>
                                        {{> _checklist_switch name="100_km_sticker"}}
                                    </tr>
                                    <tr>
                                        <td>Log book (MDC)</td>
                                        <td class="text-center">B</td>
                                        {{> _checklist_switch name="Log_book"}}
                                    </tr>
                                    <tr>
                                        <td>Air leaks</td>
                                        <td class="text-center">B</td>
                                        {{> _checklist_switch name="Air_leaks"}}
                                    </tr>
                                    <tr>
                                        <td>Stop blocks</td>
                                        <td class="text-center">B</td>
                                        {{> _checklist_switch name="Stop_blocks"}}
                                    </tr>
                                    <tr>
                                        <td>Fleet numbers</td>
                                        <td class="text-center">B</td>
                                        {{> _checklist_switch name="Fleet_numbers"}}
                                    </tr>
                                    <tr>
                                        <td>Valid public permit</td>
                                        <td class="text-center">B</td>
                                        {{> _checklist_switch name="Valid_public_permit"}}
                                    </tr>
                                    <tr>
                                        <td>Revers hooter</td>
                                        <td class="text-center">B</td>
                                        {{> _checklist_switch name="Revers_hooter"}}
                                    </tr>
                                    <tr>
                                        <td>Reflector strips</td>
                                        <td class="text-center">B</td>
                                        {{> _checklist_switch name="Reflector_strips"}}
                                    </tr>
                                    <tr>
                                        <td class="class-a">Park brake</td>
                                        <td class="text-center class-a">A</td>
                                        {{> _checklist_switch name="Park_brake"}}
                                    </tr>
                                    <tr>
                                        <td class="class-a">Emergency brake</td>
                                        <td class="text-center class-a">A</td>
                                        {{> _checklist_switch name="Emergency_brake"}}
                                    </tr>
                                    <tr>
                                        <td class="class-a">Diesel leaks</td>
                                        <td class="text-center class-a">A</td>
                                        {{> _checklist_switch name="Diesel_leaks"}}
                                    </tr>
                                    <tr>
                                        <td class="class-a">Exhaust leaks</td>
                                        <td class="text-center class-a">A</td>
                                        {{> _checklist_switch name="Exhaust_leaks"}}
                                    </tr>

                                    <tr class="section-header"><td colspan="4"><strong>Internal Checks:</strong></td></tr>

                                    <tr>
                                        <td>Warning Lights</td>
                                        <td class="text-center">B</td>
                                        {{> _checklist_switch name="Warning_Lights"}}
                                    </tr>
                                    <tr>
                                        <td class="class-a">Heat Guage</td>
                                        <td class="text-center class-a">A</td>
                                        {{> _checklist_switch name="Heat_Guage"}}
                                    </tr>
                                    <tr>
                                        <td>Hooter</td>
                                        <td class="text-center">B</td>
                                        {{> _checklist_switch name="Hooter"}}
                                    </tr>
                                    <tr>
                                        <td class="class-a">Seats & Seat Belts</td>
                                        <td class="text-center class-a">A</td>
                                        {{> _checklist_switch name="Seats_Seat_Belts"}}
                                    </tr>
                                    <tr>
                                        <td>Mirrors (rear & side)</td>
                                        <td class="text-center">B</td>
                                        {{> _checklist_switch name="Mirrors"}}
                                    </tr>
                                    <tr>
                                        <td>Room Lights</td>
                                        <td class="text-center">B</td>
                                        {{> _checklist_switch name="Room_Lights_Int"}}
                                    </tr>
                                    <tr>
                                        <td class="class-a">Fuel level (%)</td>
                                        <td class="text-center class-a">A</td>
                                        {{> _checklist_switch name="Fuel_level"}}
                                    </tr>
                                    <tr>
                                        <td class="class-a">Fuel tag</td>
                                        <td class="text-center class-a">A</td>
                                        {{> _checklist_switch name="Fuel_tag"}}
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="other-checks">
                            <p><strong>Other:</strong></p>
                            <table>
                                <tr>
                                    <td class="other-desc">Fire Extinguisher available?</td>
                                    <td class="text-center" style="width: 10%;">B</td>
                                    <td class="y-n-switch-cell">
                                         <div class="toggle-switch three-state y-n-switch" data-name="Fire_Extinguisher">
                                            <div class="switch-control">
                                                <input type="radio" name="Fire_Extinguisher" value="Y" class="status-input status-ok-input">
                                                <input type="radio" name="Fire_Extinguisher" value="N/A" class="status-input status-na-input" checked>
                                                <input type="radio" name="Fire_Extinguisher" value="N" class="status-input status-def-input">
                                                <span class="slider"></span>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="other-desc">First aid kit available?</td>
                                    <td class="text-center" style="width: 10%;">B</td>
                                    <td class="y-n-switch-cell">
                                         <div class="toggle-switch three-state y-n-switch" data-name="First_Aid_Kit">
                                            <div class="switch-control">
                                                <input type="radio" name="First_Aid_Kit" value="Y" class="status-input status-ok-input">
                                                <input type="radio" name="First_Aid_Kit" value="N/A" class="status-input status-na-input" checked>
                                                <input type="radio" name="First_Aid_Kit" value="N" class="status-input status-def-input">
                                                <span class="slider"></span>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            </table>
                        </div>

                        <!-- Footer Signatures (Enabled for Template Defaults) -->
                        <div class="remarks-section mt-3">
                            <p><strong>REPAIRS OR REMARKS DURING SHIFT</strong></p>
                            <textarea name="remarks" rows="3" style="background-color: #f9f9f9; width: 100%; box-sizing: border-box;"></textarea>
                            <div class="signature-line" style="display: flex; gap: 20px; margin-top: 10px;">
                                <p>TIME <input type="time" name="remarks_time"></p>
                                <p>SIGNATURE <input type="text" name="remarks_signature"></p>
                            </div>
                        </div>

                        <div class="signature-area page-2 mt-4">
                            <table class="signature-table w-100">
                                <tr>
                                    <td><strong>DRIVER NAME</strong><input type="text" name="driverName" class="w-100"></td>
                                    <td><strong>DRIVERS SIGNATURE</strong><input type="text" name="driverSignature" class="w-100"></td>
                                </tr>
                                <tr>
                                    <td><strong>SUPERVISOR NAME</strong><input type="text" name="supervisorName" class="w-100"></td>
                                    <td><strong>SUPERVISOR SIGNATURE</strong><input type="text" name="supervisorSignature" class="w-100"></td>
                                </tr>
                            </table>
                        </div>

                    </div>
                </div>

                <!-- ============================================= -->
                <!-- === SECTION: PORTFOLIO (Construction)     === -->
                <!-- ============================================= -->
                <div id="constructionPortfolioSection" class="col-12 mt-4" style="display:none;">
                    <div class="mb-3 border-bottom pb-2">
                        <h6 class="text-primary">Construction Project Portfolio</h6>
                        <p class="text-muted small mb-0">Add up to 3 featured projects to showcase on this service page.</p>
                    </div>
                    <div class="row g-3">
                        {{#each (array '1' '2' '3')}}
                        <div class="col-md-4">
                            <div class="border rounded p-3 bg-light h-100">
                                <strong class="d-block mb-2">Project {{this}}</strong>
                                <div class="mb-2">
                                    <label class="form-label small">Project Title</label>
                                    <input type="text" name="portfolio_{{this}}_title" class="form-control form-control-sm">
                                </div>
                                <div class="mb-2">
                                    <label class="form-label small">Description</label>
                                    <textarea name="portfolio_{{this}}_desc" class="form-control form-control-sm" rows="2"></textarea>
                                </div>
                                <div class="mb-2">
                                    <label class="form-label small">Image</label>
                                    <input type="file" name="portfolio_{{this}}_image" class="form-control form-control-sm" accept="image/*">
                                </div>
                            </div>
                        </div>
                        {{/each}}
                    </div>
                </div>

                <div class="col-12 mt-3">
                    <button type="submit" class="btn btn-primary w-100">Create Service</button>
                </div>
            </form>
        </div>
    </div>
    
    {{#if services}}
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>Title</th>
                    <th>Provider</th>
                    <th>Category</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {{#each services}}
                <tr>
                    <td><a href="/services/{{_id}}">{{title}}</a></td>
                    <td>{{provider.name}}</td>
                    <td>{{category}}</td>
                    <td>
                        <a href="/services/edit/{{_id}}" class="btn btn-sm btn-secondary">Edit</a>
                        <form action="/services/{{_id}}?_method=DELETE" method="POST" class="d-inline">
                            <input type="submit" value="Delete" class="btn btn-sm btn-danger">
                        </form>
                    </td>
                </tr>
                {{/each}}
            </tbody>
        </table>
    </div>
    {{/if}}
  </div>

  <!-- =============================== -->
  <!-- ===    GALLERY PANE         === -->
  <!-- =============================== -->
  <div class="tab-pane fade" id="gallery-pane" role="tabpanel" aria-labelledby="gallery-tab" tabindex="0">
    <h3 class="section-title">Image Gallery</h3>
    <p class="text-muted">Manage images uploaded to the website. <strong>Warning:</strong> Deleting an image that is currently in use on the site will result in broken image links.</p>
    
    {{#if uploadedImages}}
    <div class="row row-cols-2 row-cols-md-4 row-cols-lg-6 g-3">
        {{#each uploadedImages}}
        <div class="col">
            <div class="card h-100 shadow-sm">
                <div style="height: 150px; overflow: hidden;" class="bg-light d-flex align-items-center justify-content-center">
                    <img src="{{this.url}}" alt="{{this.name}}" style="width: 100%; height: 100%; object-fit: cover;">
                </div>
                <div class="card-body p-2 d-flex flex-column">
                    <small class="text-truncate d-block mb-2" title="{{this.name}}" style="font-size: 0.75rem;">{{this.name}}</small>
                    <form action="/dashboard/images/{{this.name}}?_method=DELETE" method="POST" class="mt-auto w-100" onsubmit="return confirm('Are you sure you want to delete this image?');">
                        <button type="submit" class="btn btn-sm btn-outline-danger w-100 py-0" style="font-size: 0.8rem;">
                            <i class="fas fa-trash-alt me-1"></i> Delete
                        </button>
                    </form>
                </div>
            </div>
        </div>
        {{/each}}
    </div>
    {{else}}
    <div class="alert alert-info">No images uploaded yet.</div>
    {{/if}}
  </div>

</div>

{{!-- Inline Partial to reduce code repetition for standard switches --}}
{{#*inline "_checklist_switch"}}
    <td class="switch-td">
        <div class="switch-cell">
            <div class="toggle-switch three-state" data-name="{{name}}">
                <div class="switch-control">
                    <input type="radio" name="{{name}}" value="OK" class="status-input status-ok-input">
                    <input type="radio" name="{{name}}" value="N/A" class="status-input status-na-input" checked>
                    <input type="radio" name="{{name}}" value="DEF" class="status-input status-def-input">
                    <span class="slider"></span>
                </div>
            </div>
        </div>
    </td>
    <td class="text-center">
        <input type="time" name="{{name}}_Arr" class="form-control form-control-sm w-100 time-input">
    </td>
{{/inline}}

  {{!-- SCRIPT FOR ADMIN DASHBOARD LOGIC (Checklists, Geolocation, etc) --}}
<script>
    document.addEventListener('DOMContentLoaded', function(){
        // 1. Checklist & Form Logic
        const form = document.getElementById('createServiceForm');
        if (form) {
            const catSelect = document.getElementById('categorySelect');
            const fleetAdmin = document.getElementById('fleetDocsAdmin');
            const checklistAdmin = document.getElementById('checklistTemplateSection');
            const portfolioAdmin = document.getElementById('constructionPortfolioSection');
            
            function toggleSections(){
                const val = (catSelect.value || '').toLowerCase();
                const isTransport = val.includes('transport') || val.includes('carwash');
                const isConstruction = val.includes('construction') || val.includes('civil');

                // Toggle Transport Sections
                if (fleetAdmin) fleetAdmin.style.display = isTransport ? 'block' : 'none';
                if (checklistAdmin) checklistAdmin.style.display = isTransport ? 'block' : 'none';
                
                // Toggle Construction Sections
                if (portfolioAdmin) portfolioAdmin.style.display = isConstruction ? 'block' : 'none';
            }
            
            if (catSelect) catSelect.addEventListener('change', toggleSections);
            
            // Add Checklist Item Logic (For Fleet Docs - Legacy/Simple)
            document.addEventListener('click', function(e){
                if (e.target.classList.contains('add-checklist-item')) {
                    e.preventDefault();
                    const docNum = e.target.dataset.doc;
                    const container = document.querySelector(`.checklist-items[data-doc="${docNum}"]`);
                    if (!container) return;
                    
                    const items = container.querySelectorAll('.checklist-item').length;
                    const newIndex = items + 1;
                    const newItem = document.createElement('div');
                    newItem.className = 'checklist-item mb-2';
                    newItem.innerHTML = `
                        <div class="input-group input-group-sm">
                            <input type="text" name="fleet_doc_${docNum}_checklist_${newIndex}_item" class="form-control" placeholder="Item" data-item-index="${newIndex}">
                            <input type="text" name="fleet_doc_${docNum}_checklist_${newIndex}_category" class="form-control" placeholder="Cat" style="max-width: 100px;">
                        </div>
                    `;
                    container.appendChild(newItem);
                }
            });

            // --- TIME INPUT VISUAL LOGIC ---
            const timeInputs = document.querySelectorAll('.time-input');
            function updateTimeInputVisual(input) {
                if (input.value) input.classList.add('filled');
                else input.classList.remove('filled');
            }
            timeInputs.forEach(input => {
                updateTimeInputVisual(input);
                input.addEventListener('input', () => updateTimeInputVisual(input));
            });

            // --- 3-STATE TOGGLE LOGIC ---
            const checklistToggles = document.querySelectorAll('#checklistTemplateSection .toggle-switch.three-state');
            checklistToggles.forEach(switchContainer => {
                const name = switchContainer.dataset.name;
                const isYN = switchContainer.classList.contains('y-n-switch');
                const STATES = isYN ? ['Y', 'N/A', 'N'] : ['OK', 'N/A', 'DEF'];
                
                const inputs = {};
                STATES.forEach(state => {
                    const input = switchContainer.querySelector(`input[value="${state}"]`);
                    if (input) inputs[state] = input;
                });

                switchContainer.addEventListener('click', (e) => {
                    e.preventDefault();
                    let currentValue = null;
                    for (const state of STATES) {
                        if (inputs[state] && inputs[state].checked) {
                            currentValue = state;
                            break;
                        }
                    }
                    const currentIndex = currentValue ? STATES.indexOf(currentValue) : -1;
                    const nextIndex = (currentIndex + 1) % STATES.length;
                    const nextState = STATES[nextIndex];
                    if (inputs[nextState]) {
                        inputs[nextState].checked = true;
                    }
                });
            });

            // Handle JSON Serialization for Checklist Template
            form.addEventListener('submit', function(e){
                if(checklistAdmin && checklistAdmin.style.display !== 'none'){
                    const data = {};
                    
                    // A. Iterate through checklist rows (Status + Arr)
                    const rows = checklistAdmin.querySelectorAll('table tbody tr');
                    rows.forEach(row => {
                        const checkedRadio = row.querySelector('input[type="radio"]:checked');
                        if (!checkedRadio) return; 
                        
                        const name = checkedRadio.name;
                        const status = checkedRadio.value;
                        
                        const timeInput = row.querySelector('input[type="time"]');
                        const timeVal = timeInput ? timeInput.value : '';
                        
                        data[name] = {
                            Status: status,
                            Arr: timeVal
                        };
                    });

                    // B. Capture Shift
                    const shiftRadio = checklistAdmin.querySelector('input[name="shift"]:checked');
                    if(shiftRadio) data['shift'] = shiftRadio.value;

                    // C. Capture Other Checks
                    const otherChecks = ['Fire_Extinguisher', 'First_Aid_Kit'];
                    otherChecks.forEach(name => {
                        const radio = checklistAdmin.querySelector(`input[name="${name}"]:checked`);
                        if(radio) data[name] = radio.value;
                    });

                    // D. Capture Info Grid Inputs (Top Section)
                    const infoFields = ['date', 'department', 'registrationNo', 'odometerReading', 'route', 'seatsOccupied', 'toSite', 'return'];
                    infoFields.forEach(field => {
                        const input = checklistAdmin.querySelector(`input[name="${field}"]`);
                        if(input && input.value) data[field] = input.value;
                    });

                    // E. Capture Footer Inputs (Bottom Section)
                    const footerFields = ['remarks', 'remarks_time', 'remarks_signature', 'driverName', 'driverSignature', 'supervisorName', 'supervisorSignature'];
                    footerFields.forEach(field => {
                        // Check specifically within the checklist section to avoid name collisions
                        const input = checklistAdmin.querySelector(`[name="${field}"]`); 
                        if(input && input.value) data[field] = input.value;
                    });

                    document.getElementById('checklist_template_json').value = JSON.stringify(data);
                }
            });

            // Initial toggle
            toggleSections();
        }

        // 2. Geolocation Logic
        const geoBtn = document.getElementById('btn-geo-locate');
        const geoInput = document.getElementById('contact_map_query');
        
        if (geoBtn && geoInput) {
            geoBtn.addEventListener('click', function() {
                if (navigator.geolocation) {
                    geoBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Locating...';
                    navigator.geolocation.getCurrentPosition(function(position) {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        geoInput.value = `${lat}, ${lng}`;
                        geoBtn.innerHTML = '<i class="fas fa-check"></i> Found';
                        setTimeout(() => geoBtn.innerHTML = '<i class="fas fa-map-marker-alt"></i> Use Current Location', 2000);
                    }, function(error) {
                        alert('Error getting location: ' + error.message);
                        geoBtn.innerHTML = '<i class="fas fa-map-marker-alt"></i> Use Current Location';
                    });
                } else {
                    alert('Geolocation is not supported by this browser.');
                }
            });
        }
    });
</script>
</div>