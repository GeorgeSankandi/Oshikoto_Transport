<h1 class="display-5">Provider Dashboard</h1>
<p class="lead">Welcome, {{user.name}}. Manage your services and bookings here.</p>
<hr>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h3 class="section-title mb-0">My Services</h3>
    <a href="/services/add" class="btn btn-primary">Add New Service</a>
</div>

{{!-- Services Table --}}
{{#if services}}
<div class="table-responsive mb-5">
    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th>Title</th>
                <th>Category</th>
                <th>Price</th>
                <th>On Sale</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {{#each services}}
            <tr>
                <td><a href="/services/{{_id}}">{{title}}</a></td>
                <td>{{category}}</td>
                <td>N$ {{price}}</td>
                <td>{{#if onSale}}Yes{{else}}No{{/if}}</td>
                <td>
                    <a href="/services/edit/{{_id}}" class="btn btn-sm btn-secondary">Edit</a>
                    <form action="/services/{{_id}}?_method=DELETE" method="POST" class="d-inline" onsubmit="return confirm('Delete this service?');">
                        <button type="submit" class="btn btn-sm btn-danger"><i class="fas fa-trash"></i></button>
                    </form>
                </td>
            </tr>
            {{/each}}
        </tbody>
    </table>
</div>
{{else}}
<div class="card text-center p-4 mb-5">
    <p class="mb-0">You have not added any services yet. Click 'Add New Service' to begin.</p>
</div>
{{/if}}

<h3 class="section-title">Booking Requests</h3>
{{#if bookings}}
<div class="table-responsive">
    <table class="table table-striped table-hover align-middle">
       <thead>
            <tr>
                <th style="width: 15%;">Client</th>
                <th style="width: 20%;">Service</th>
                <th style="width: 15%;">Date & Time</th>
                <th style="width: 25%;">Status / Approval</th> {{!-- Column for Badge + Dropdown --}}
                <th style="width: 15%;">Checklist</th>
                <th style="width: 10%;">Delete</th>
            </tr>
        </thead>
        <tbody>
            {{#each bookings}}
            <tr>
                <td>{{client.name}}</td>
                <td>{{service.title}}</td>
                <td>{{formatDate bookingDate 'MMMM Do YYYY, HH:mm'}}</td>
                
                {{!-- STATUS APPROVAL COLUMN --}}
                <td>
                    <div class="d-flex flex-column gap-2">
                        {{!-- 1. Current Status Badge --}}
                        <div>
                            {{#if (ifeq status 'Pending')}}
                                <span class="badge bg-warning text-dark">Pending</span>
                            {{/if}}
                            {{#if (ifeq status 'Confirmed')}}
                                <span class="badge bg-success">Confirmed</span>
                            {{/if}}
                            {{#if (ifeq status 'Completed')}}
                                <span class="badge bg-primary">Completed</span>
                            {{/if}}
                            {{#if (ifeq status 'Cancelled')}}
                                <span class="badge bg-danger">Cancelled</span>
                            {{/if}}
                        </div>

                        {{!-- 2. Approval Dropdown Form --}}
                        <form action="/bookings/status/{{_id}}" method="POST">
                            <select name="status" class="form-select form-select-sm" onchange="this.form.submit()">
                                <option value="Pending" {{#if (ifeq status 'Pending')}}selected{{/if}}>Pending</option>
                                
                                {{!-- Logic: Disable 'Confirmed' if no checklist exists --}}
                                <option value="Confirmed" 
                                    {{#if (ifeq status 'Confirmed')}}selected{{/if}}
                                    {{#unless hasChecklist}}disabled{{/unless}}>
                                    Confirmed {{#unless hasChecklist}}(Fill Checklist First){{/unless}}
                                </option>
                                
                                <option value="Completed" {{#if (ifeq status 'Completed')}}selected{{/if}}>Completed</option>
                                <option value="Cancelled" {{#if (ifeq status 'Cancelled')}}selected{{/if}}>Cancelled</option>
                            </select>
                        </form>
                    </div>
                </td>

                {{!-- CHECKLIST BUTTONS --}}
                <td>
                    <a href="/dashboard/checklist/{{this._id}}" class="btn btn-sm {{#if this.hasChecklist}}btn-success{{else}}btn-outline-primary{{/if}} mb-1 w-100">
                        <i class="fas {{#if this.hasChecklist}}fa-check{{else}}fa-edit{{/if}} me-1"></i>
                        {{#if this.hasChecklist}}Edit{{else}}Fill{{/if}}
                    </a>
                    
                    {{#if this.hasChecklist}}
                    <a href="/bookings/{{this._id}}/checklist/download" class="btn btn-sm btn-outline-dark w-100" target="_blank" title="Download PDF">
                        <i class="fas fa-file-pdf me-1"></i> PDF
                    </a>
                    {{/if}}
                </td>

                {{!-- DELETE BUTTON --}}
                <td>
                    <form action="/bookings/{{this._id}}?_method=DELETE" method="POST" class="d-inline" onsubmit="return confirm('Decline and delete this booking request?');">
                        <button type="submit" class="btn btn-sm btn-danger">
                            <i class="fas fa-trash"></i>
                        </button>
                    </form>
                </td>
            </tr>
            {{/each}}
        </tbody>
    </table>
</div>
{{else}}
<div class="card text-center p-4">
    <p class="mb-0">You have no booking requests at this time.</p>
</div>
{{/if}}